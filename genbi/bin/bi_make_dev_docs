#!/usr/bin/env perl

use strict;
use warnings;

use File::Find;
use File::Path;
use File::Spec;
use Pod::Simple::HTML;

my $POD_DIR = File::Spec->catdir('src');
my $HTML_DIR = File::Spec->catdir('docs', 'dev', 'html');

find({ wanted => \&wanted, no_chdir => 1 }, $POD_DIR);

sub wanted {
    my $podfile = $_;
    my $htmlfile;
    my $html;
    my $out;

    if ($podfile =~ /\.pm$/i) {    	
    	$htmlfile = $podfile;
    	$htmlfile =~ s/\.pm$/\.html/;
    	$htmlfile =~ s/$POD_DIR\/?//;
        $htmlfile =~ s/\//::/g;
        $htmlfile = File::Spec->catfile($HTML_DIR, $htmlfile);
    	
    	my ($volume, $dir, $file) = File::Spec->splitpath($htmlfile);
    	$dir = File::Spec->catpath($volume, $dir);
    	mkpath($dir);
    	
        my $parser = Pod::Simple::HTML->new();
        $parser->perldoc_url_prefix('');
        $parser->perldoc_url_postfix('.html');
    	$parser->output_string(\$html);
    	$parser->parse_file($podfile);
    	
    	open $out, '>', $htmlfile or die "Cannot open '$htmlfile': $!";
    	print $out $html;
    	close $out;
    }
}
